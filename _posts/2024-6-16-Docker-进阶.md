---
layout:     post
title:      Docker 进阶
subtitle:   应用容器 Docker
date:       2024-6-16
author:     WHH
header-img: img/docker.png
catalog: true
tags:
    - Docker


---

> 上篇文章对docker有了一个基本的了解 现在开始学习进阶内容

# 一. Dockerfile

**什么是Dockerfile**

Dockerfile是一个文本文件,包含了构建Docker镜像的所有指令

Dockerfile是一个用来构建镜像的文本文件,文本内容包含了一条条构建镜像所需的指令和说明

通过定义一系列命令和参数,Dockerfile指导Docker构建一个自定义的镜像

### 使用Dockerfile的好处

- **环境一致性**
  - 不管在开发环境,测试环境,还是线上环境,运行的都是同一个镜像,同一套环境
  - 不用担心开发能跑,线上出错

- **自动化构建**
  - 代码化的镜像构建规范,可以直接结合CI/CD流水线
  - 自动拉取代码,构建镜像,打tag,推送到镜像仓库
  - 减少人工操作,提高部署效率和稳定性

- **快速部署 & 回滚**
  - 使用Dockerfile构建出的镜像可直接启动为容器,极快部署上线
  - 出现问题时,直接切换回老版本镜像,秒级回滚

- **版本管理和可追溯性**
  - 和Git 一样,可以做到构建可追溯, 可回滚
  - 信任只要clone项目, build一下镜像就能跑起来, 不需要配置复杂开发环境

- **可移植性**
  - 本地,阿里云,AWS,K8s,设置别人的电脑完全一致运行
  - 实现一次构建,导出运行

- **资源隔离,运行更安全**
  - 容器间隔离,不会影响宿主机
  - 可以限制资源,控制用户,设置网络,减少攻击面

**`Dockerfile带来的,是可复制,可迁移,自动化的交付能力,是现代DevOps的核心组层`**

### 常用命令及作用

|     指令      |                      说明                       |
| :-----------: | :---------------------------------------------: |
|    `from`     |         指定基础镜像(必须为第一个指令)          |
|    `LABEL`    |          添加元数据,如作者,版本等信息           |
|     `RUN`     |     在构建镜像时执行命令(通常用于安全依赖)      |
|    `COPY`     |            将宿主机文件复制到镜像中             |
|     `ADD`     |   类似于`COPY`,但支持解压`.tar`文件和URL下载    |
|   `WORDIR`    |             是指后续命令的工作目录              |
|     `ENV`     |                  设置环境变量                   |
|   `EXPOSE`    |        声明容器运行时监听的端口(不映射)         |
|     `CMD`     | 容器启动时,默认执行的命令(可别`docker run`代替) |
| `ENTRYPOINT`  |   容器启动时默认执行的命令(更强制,不易被覆盖)   |
|   `VOLUME`    |            声明挂载点,用于数据持久化            |
|     `ARG`     |         定义构建参数(只能用于构建阶段)          |
|    `USER`     |             指定云心该容器时的用户              |
| `HEALTHCHECK` |              定义容器健康检查方式               |
|   `ONBUILD`   |      给付镜像定义触发器,子镜像构建时会执行      |
|    `SHELL`    |       指定shell类型,如`bash`用于后续`run`       |

### 例子

```python
FROM python:3.11-slim

WORKIR /app # 设置工作目录
COPY requirements.txt ./ # 把宿主机文件复制到镜像的 app下
RUN pip install --no-cache-dir -r requirements.txt # 执行命令 

CPPY . .  # 拷贝所有文件到镜像中

EXPOSE 8000 # 端口

CMD ['python', 'run'] # 执行命令
```

